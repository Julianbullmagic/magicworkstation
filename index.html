<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookings Calendar</title>
    <style>
:root {
  --light-green: #e0f0e3;
  --medium-green: #a3c1ad;
  --dark-green: #5a9178;
  --light-brown: #d2b48c;
  --dark-brown: #8b4513;
}

body {
  font-family: Arial, sans-serif;
  background-color: var(--light-green);
  color: var(--dark-brown);
  line-height: 1.6;
  margin: 0;
}

.tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }
        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
        }
        .tab button:hover {
            background-color: #ddd;
        }
        .tab button.active {
            background-color: #ccc;
        }
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }

h1 {
  color: var(--dark-green);
  text-align: center;
  margin-bottom: 30px;
  display: block;
}

#events,#leads  {
  display: flex; /* Ensure flex container for responsive layout */
  flex-wrap: wrap; /* Allow events to wrap onto multiple lines */
  justify-content: space-around; /* Distribute events evenly */}

.event {
  background-color: white;
  width: calc(43vw); /* Adjust width for desktop layout */
  margin-bottom:3vh;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  padding: 2vw;
  transition: transform 0.3s ease;
}

.event:hover {
  transform: translateY(-5px);
}

.event h3 {
  color: var(--dark-green);
  font-size: 1.2em;
  margin-bottom: 15px;
}

.event form {
  display: grid;
  gap: 10px;
}


.checkboxes-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* Create 3 equal columns */
  gap: 10px;
}

.event label {
  display: flex;
  align-items: center;
  color: var(--dark-brown);
  margin-bottom: 5px;
}

.event input[type="text"],
.event input[type="datetime-local"],
.event input[type="tel"],
.event input[type="number"],
.event input[type="email"] {
  width: 90%;
  padding: 1%;
  border: 1px solid var(--medium-green);
  border-radius: 4px;
  font-size: 14px;
}

.event input[type="checkbox"] {
  margin-right: 5px;
  display:inline;
}
.event label[type="checkbox"] {
  margin-right: 15px;
  display:inline;
}

.event button {
  background-color: var(--dark-green);
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  font-size: 16px;
  margin-top: 10px;
}

.event button:hover {
  background-color: var(--medium-green);
}

.event .request-info {
  background-color: var(--light-brown);
}

.event .request-info:hover {
  background-color: var(--dark-brown);
}

@media (min-width: 768px) {
  /* Ensure two events fit per row */
  .event {
    /* No need to change width here as it's already set in the base rule */
  }
}

@media (max-width: 767px) {
  body {
    padding: 10px;
  }

  .event {
    padding: 15px;
    width: calc(100% - 20px); /* Ensure one event fits per row */
  }

  .event input[type="text"],
  .event input[type="datetime-local"],
  .event input[type="tel"],
  .event input[type="number"],
  .event input[type="email"] {
    font-size: 16px; /* Larger font size for mobile */
  }

  .event button {
    width: 100%; /* Full width buttons on mobile */
    margin-top: 15px;
  }
}

    </style>
</head>
<body>
    <h1>Booking and Lead Management</h1>

    <div class="tab">
        <button class="tablinks" onclick="openTab(event, 'Bookings')" id="defaultOpen">Bookings</button>
        <button class="tablinks" onclick="openTab(event, 'Leads')">Leads</button>
    </div>
    <div id="Bookings" class="tabcontent">
      <h2>Bookings</h2>
      <div id="events">
      </div>
  </div>

  <div id="Leads" class="tabcontent">
      <h2>Leads</h2>
      <div id="leads">
      </div>
  </div>
    <script>
        let informationrequested=false
        let server="http://localhost:3000"

        syncCalendar()
        fetchAllItems();

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        // Get the element with id="defaultOpen" and click on it
        document.getElementById("defaultOpen").click();

        function formatDateTimeLocal(dateString) {
  return new Date(dateString).toISOString().slice(0, 16);
}

async function syncCalendar() {
  try {
    const response = await fetch(server+'/api/sync-calendar', {
      method: 'POST',
    });
    if (!response.ok) {
      throw new Error('Calendar sync failed');
    }
    console.log('Calendar synced successfully');
  } catch (error) {
    console.error('Error syncing calendar:', error);
  }
}

async function fetchAllItems() {
    try {
        const bookingsresponse = await fetch(server+'/api/bookings');
        if (!bookingsresponse.ok) {
            throw new Error('Failed to fetch bookings');
        }
        const leadsresponse = await fetch(server+'/api/leads');
        if (!leadsresponse.ok) {
            throw new Error('Failed to fetch bookings');
        }
         let leads = await leadsresponse.json();
         let bookings = await bookingsresponse.json();
        console.log(leads,"leads")
        console.log(bookings,"bookings")
        displayItems(leads);
        displayItems(bookings);
    } catch (error) {
        console.error('Error fetching Items:', error);
        document.getElementById('events').innerHTML = '<p>Error loading bookings. Please try again later.</p>';
        document.getElementById('leads').innerHTML = '<p>Error loading leads. Please try again later.</p>';
    }
}

// Fetch all bookings when the program opens
function displayItems(items, isFullUpdate = true) {
  let eventsContainer
  let type=items.type
  if(type=="Bookings"){
    eventsContainer = document.getElementById('events');
  }
  if(type=="Leads"){
    eventsContainer = document.getElementById('leads');
  }
  if (!eventsContainer) {
    console.error("Events container not found!");
    return;
  }
  
  if (isFullUpdate) {
    eventsContainer.innerHTML = '';
  }
  
  const now = new Date();
  items=items.data
  console.log(items)
  items.forEach((item) => {
    let eventElement = document.getElementById(`event-${item.id}`);
    if (!eventElement) {
      eventElement = document.createElement('div');
      eventElement.id = `event-${item.id}`;
      eventElement.className = 'event';
      eventsContainer.appendChild(eventElement);
    }
    
    const startTime = new Date(item.start_time);
    const endTime = new Date(item.end_time);
    const oneWeekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
    
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    let hasValidEmailAddress = item.email_address && isValidEmail(item.email_address);

    eventElement.innerHTML = `
      <h3>${item.event_name || item.customer_name || 'Untitled Event'}</h3>
      <form id="form-${item.id}">
        <label>Event Name: <input type="text" name="event_name" value="${item.event_name || ''}"></label>
        <label>Customer Name: <input type="text" name="customer_name" value="${item.customer_name || ''}"></label>
        <label>Start Time: <input type="datetime-local" name="start_time" value="${formatDateTimeLocal(item.start_time)}"></label>
        <label>End Time: <input type="datetime-local" name="end_time" value="${formatDateTimeLocal(item.end_time)}"></label>
        <label>Email Address: <input type="email" name="email_address" value="${item.email_address || ''}"></label>
        <label>Phone Number: <input type="tel" name="phone_number" value="${item.phone_number || ''}"></label>
        <label>Address: <input type="text" name="address" value="${item.address || ''}"></label>
        <label>Price: <input type="number" name="price" value="${item.price || 0}" step="0.01"></label>
                            ${type=="Leads"?`
        <label>Website: <input type="text" name="website" value="${item.website || ''}" step="0.01"></label>
                    `:``}
        ${type=="Bookings"?`
        <div class="checkboxes-container">
          <label>Cash: <input type="checkbox" name="cash" ${item.cash ? 'checked' : ''}></label>
          ${endTime < now ? `<label>Customer Happy: <input type="checkbox" name="customer_happy" ${item.customer_happy ? 'checked' : ''}></label>` : ''}
          ${item.sent_invoice ? `<label>Deposit Paid: <input type="checkbox" name="deposit_paid" ${item.deposit_paid ? 'checked' : ''}></label>` : ''}
          <label>Microphone Needed: <input type="checkbox" name="microphone_needed" ${item.microphone_needed ? 'checked' : ''}></label>
          ${endTime < now ? `<label>Full Payment Made: <input type="checkbox" name="full_payment_made" ${item.full_payment_made && item.sent_invoice ? 'checked' : ''}></label>` : ''}
          
        </div>`:``}
        <button type="submit">Update</button>
        ${type=="Leads"? `<button id="ready-to-book-${item.id}" class="request-info">Ready To Book?</button>` : ''}
        ${item.email_address ? `
          ${hasValidEmailAddress ? `
                        ${type=="Bookings"?`
            ${endTime < now&&!item.review_requested? `<button id="request-review-${item.id}" class="request-info">Request Review</button>` : ''}
            ${!item.info_requested ? `<button id="request-info-${item.id}" class="request-info">Request Information</button>` : ''}
            ${item.price && item.customer_name ? 
              (!item.sent_invoice ? `<button id="send-invoice-${item.id}" class="request-info">Send Invoice</button>` : '')
              : '<p style="color:red;">Please enter the customer name and booking price before sending invoice.</p>'}
            ${endTime > now ? `
              ${startTime < oneWeekFromNow ? 
                (!item.few_days_before ? `
                  <p>This booking is less than a week away, send reminder to customer</p>
                  <button id="send-final-booking-reminder-${item.id}" class="request-info">Send Final Booking Reminder</button>
                ` : '')
              : ''}
            ` : ''}
            `:``}
                    ${type=="Leads"&&!item.sent_follow_up_email?`
                          <button id="email-follow-up-if-interested-${item.id}" class="request-info">Email follow up if interested</button>
                    `:``}
          ` : '<p style="color:red;">Email address is not valid format or non-existent</p>'}
        ` : ''}
                <button id="delete-${item.id}" class="request-info">Delete</button>
      </form>
    `;

    document.getElementById(`form-${item.id}`).addEventListener('submit', (e) => {
      e.preventDefault();
      console.log(item,item.id,type,"id and type")
      updateItem(item.id,type);
    });

    document.getElementById(`delete-${item.id}`).addEventListener('click',async (e) => {
      e.preventDefault();
      console.log(item,item.id,type,"id and type")      
      const isConfirmed = confirm("Are you sure you want to delete this?");
if (isConfirmed) {
    document.getElementById(`event-${item.id}`).remove();
      await fetch(server + '/delete', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                bookingid: item.id,
                type:type
              }),
            });  
          }
        });
        async function fetchAndDisplayBookings() {
  try {
    const response = await fetch(server + '/api/bookings');
    if (!response.ok) {
      throw new Error('Failed to fetch bookings');
    }
    const bookingsData = await response.json();
    // Function to display bookings in the DOM
    displayBookings(bookingsData.data);
  } catch (error) {
    console.error('Error fetching bookings:', error);
  }
}

// Lead conversion event listener
if (type == "Leads") {
  document.getElementById(`ready-to-book-${item.id}`).addEventListener('click', async (e) => {
    e.preventDefault();
    console.log(item, item.id, type, "id and type");
    
    const isConfirmed = confirm("Are you sure you want to convert this to a booking?");
    
    if (isConfirmed) {
      try {
        const response = await fetch(server + '/convert-lead-to-booking', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            leadId: item.id
          }),
        });

        if (!response.ok) {
          throw new Error('Failed to convert lead to booking');
        }

        const result = await response.json();
        console.log('Lead converted to booking successfully. New booking ID:', result.newBookingId);

        // Remove the lead from the DOM
        document.getElementById(`event-${item.id}`).remove();

        // Refresh the bookings list
        await fetchAllItems();

        // Optionally, you might want to scroll to the new booking or highlight it
        // This depends on how your displayBookings function works
        const newBookingElement = document.getElementById(`event-${result.newBookingId}`);
        if (newBookingElement) {
          newBookingElement.scrollIntoView({ behavior: 'smooth' });
          newBookingElement.classList.add('highlight');
          setTimeout(() => newBookingElement.classList.remove('highlight'), 3000);
        }

      } catch (error) {
        console.error('Error converting lead to booking:', error);
        alert('An error occurred while converting the lead to a booking. Please try again.');
      }
    } else {
      console.log('Conversion cancelled by user');
    }
  });
}
        
    if(hasValidEmailAddress){
      const requestInfoButton = document.getElementById(`request-info-${item.id}`);
      if (requestInfoButton) {
        requestInfoButton.addEventListener('click', async (e) => {
          e.preventDefault();
          const emailContent = generateInfoRequestEmail(item);
          console.log(emailContent, "emailContent");
          try {
            if(emailContent){
              await fetch(server + '/send-email', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  to: item.email_address,
                  subject: `Information Request for Your Event on ${new Date(item.start_time).toLocaleDateString()}`,
                  text: emailContent,
                }),
              });
            }
            item.info_requested = true;
            await updateBookingInDatabase(item);
            requestInfoButton.remove();
          } catch (error) {
            console.error('Error sending information request:', error);
          }
        });
      }

      const requestReviewButton = document.getElementById(`request-review-${item.id}`);
      if (requestReviewButton) {
        requestReviewButton.addEventListener('click', async (e) => {  
          e.preventDefault();
          try {
            await fetch(server + '/send-email', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                to: item.email_address,
                subject: `Review Request`,
                booking: generateReviewRequestEmail(item),
              }),
            });
            item.review_requested = true;
            await updateBookingInDatabase(item);
            requestReviewButton.remove();
          } catch (error) {
            console.error('Error sending invoice:', error);
          }
        });  
      }

      const sendInvoiceButton = document.getElementById(`send-invoice-${item.id}`);
      if (sendInvoiceButton) {
        sendInvoiceButton.addEventListener('click', async (e) => {  
          e.preventDefault();
          try {
            await fetch(server + '/send-invoice-request', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                to: item.email_address,
                subject: `Invoice for the Magic Show at your Event on ${new Date(item.start_time).toLocaleDateString()}`,
                text: item,
              }),
            });
            item.sent_invoice = true;
            await updateBookingInDatabase(item);
            sendInvoiceButton.remove();
          } catch (error) {
            console.error('Error sending invoice:', error);
          }
        });  
      }

      const sendFinalReminderButton = document.getElementById(`send-final-booking-reminder-${item.id}`);
      if (sendFinalReminderButton) {
        sendFinalReminderButton.addEventListener('click', async (e) => {  
          e.preventDefault();
          try {
            await fetch(server + '/send-email', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                to: booking.email_address,
                subject: `Reminder: Your Upcoming Magic Show on ${new Date(item.start_time).toLocaleDateString()}`,
                text: generateFinalReminderEmail(item),
              }),
            });
            item.few_days_before = true;
            await updateBookingInDatabase(item);
            sendFinalReminderButton.remove();
            sendFinalReminderButton.previousElementSibling.remove(); // Remove the paragraph above the button
          } catch (error) {
            console.error('Error sending final booking reminder:', error);
          }
        });
      }

     if(type=="Leads"){
      const followUpIfInterestedButton = document.getElementById(`email-follow-up-if-interested-${item.id}`);
      if (followUpIfInterestedButton) {
        followUpIfInterestedButton.addEventListener('click', async (e) => {  
          e.preventDefault();
          try {
            await fetch(server + '/send-email', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                to: booking.email_address,
                subject: `Potential Magic Show Booking`,
                text: generateFollowUpIfInterestedEmail(item),
              }),
            });
            item.sent_follow_up_email = true;
            await updateBookingInDatabase(item);
            followUpIfInterestedButton.remove();
            // followUpIfInterestedButton.previousElementSibling.remove(); // Remove the paragraph above the button
          } catch (error) {
            console.error('Error sending follow up if interested email:', error);
          }
        });
      }
     }



    }
  });

  if (isFullUpdate) {
    Array.from(eventsContainer.children).forEach(child => {
      const id = child.id.replace('event-', '');
      if (!items.some(booking => booking.id === id)) {
        eventsContainer.removeChild(child);
      }
    });
  }
}

async function updateBookingInDatabase(booking) {
  try {
    const response = await fetch(server+'/api/bookings/update', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(booking),
    });
    if (!response.ok) {
      throw new Error('Failed to update booking');
    }
  } catch (error) {
    console.error('Error updating booking:', error);
  }
}

function generateFollowUpIfInterestedEmail(booking) {
  return `Dear ${booking.customer_name},

Are you still interested in booking a magic show on ${new Date(booking.start_time).toLocaleDateString()} at ${booking.address}?

Best regards,

Julian Bull`;
}

function generateFinalReminderEmail(booking) {
  return `Dear ${booking.customer_name},

This is a friendly reminder about your upcoming magic show event on ${new Date(booking.start_time).toLocaleDateString()} at ${booking.address}.

If you have any last-minute questions or concerns, please don't hesitate to reach out.

Looking forward to a magical event!

Best regards,

Julian Bull`;
}

function generateReviewRequestEmail(booking) {
  return `Dear ${booking.customer_name},

Would you mind leaving a review of Julianbullmagic on my facebook page? facebook.com/Julianbullmagic

Best regards,

Julian Bull`;
}

function generateInfoRequestEmail(booking) {
  let message = `Hi ${booking.customer_name || 'there'},\n\n`;
  message += "I need some additional information for your upcoming event. Could you please provide the following details:\n\n";
 let sendMessage=false
  const questions = {
    phone_number: "What is your contact phone number?",
    address: "What is the address of the event?",
    cash: "Will you be paying in cash? Any method is fine with me except credit or debit card.",
    microphone_needed: "Will you need a microphone for this event?",
  };

  for (const [key, question] of Object.entries(questions)) {
    if (booking[key] === null) {
      console.log(key)
      sendMessage=true
      message += `${question}\n`;
    }
  }

  message += "\nThank you for your help. We look forward to making your event a success!";
console.log(message)
  if(sendMessage){
    return message;
  }
  if(!sendMessage){
    return null
  }
}

function updateItem(id,type) {
  const form = document.getElementById(`form-${id}`);
  console.log(form);
  const updatedItem = {
    id: id,
    start_time: new Date(form.start_time.value).toISOString(),
    end_time: new Date(form.end_time.value).toISOString(),
    address: form.address.value || null,
    phone_number: form.phone_number.value || null,
    email_address: form.email_address.value || null,
    customer_name: form.customer_name.value || null,
    event_name: form.event_name.value || null,
  };

  if(type=="Bookings"){
    updatedItem.price=0
    updatedItem.cash= null
    updatedItem.customer_happy= null
    updatedItem.deposit_paid= null
    updatedItem.few_days_before= null
    updatedItem.microphone_needed= null
    updatedItem.review_requested= null
    updatedItem.full_payment_made= null
    updatedItem.sent_invoice= null
  }
  if(type=="Leads"){
    updatedItem.website= null
    updatedItem.sent_follow_up_email= null
  }
  if (form.website) updatedItem.website = form.website.value;
  if (form.price) updatedItem.price = parseFloat(form.price.value) || 0;
  if (form.cash) updatedItem.cash = form.cash.checked;
  if (form.customer_happy) updatedItem.customer_happy = form.customer_happy.checked;
  if (form.deposit_paid) updatedItem.deposit_paid = form.deposit_paid.checked;
  if (form.few_days_before) updatedItem.few_days_before = form.few_days_before.checked;
  if (form.microphone_needed) updatedItem.microphone_needed = form.microphone_needed.checked;
  if (form.review_requested) updatedItem.review_requested = form.review_requested.checked;
  if (form.full_payment_made) updatedItem.full_payment_made = form.full_payment_made.checked;
  if (form.sent_invoice) updatedItem.sent_invoice = form.sent_invoice.checked;

 console.log(type,"type")

  // Send update to server using fetch
  fetch(`http://localhost:3000/api/${type.toLowerCase()}/update`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(updatedItem),
  })
  .then(response => response.json())
  .then(data => {
    console.log('Update successful:', data);
    // Optionally update the display here if needed
    displayItems([data.data], false);
  })
  .catch(error => {
    console.error('Error updating item:', error);
    // Handle error (e.g., show an error message to the user)
  });
}
    </script>
</body>
</html>