<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookings Calendar</title>
    <style>
:root {
  --light-green: #e0f0e3;
  --medium-green: #a3c1ad;
  --dark-green: #5a9178;
  --light-brown: #d2b48c;
  --dark-brown: #8b4513;
}

body {
  font-family: Arial, sans-serif;
  background-color: var(--light-green);
  color: var(--dark-brown);
  line-height: 1.6;
  margin: 0;
  padding: 20px;
}

/* Headings */
h1, h2, h3 {
  text-align: center;
  color: var(--dark-green);
}

h1 {
  margin-bottom: 30px;
}

h2 {
  margin-bottom: 20px;
}

.event h3 {
  margin-bottom: 15px;
}

/* Tab styles */
.tab {
  overflow: hidden;
  border: none;
  background-color: transparent;
  display: flex;
  justify-content: center;
  margin-bottom: 20px;
}

.tab button {
  background-color: var(--dark-green);
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  font-size: 16px;
  margin: 0 5px;
}

.tab button:hover {
  background-color: var(--medium-green);
}

.tab button.active {
  background-color: var(--medium-green);
}

.tabcontent {
  display: none;
  padding: 6px 12px;
  border: none;
}

/* Event and Lead containers */
#events, #leads {
  display: flex;
  flex-wrap: wrap;
  justify-content: space-around;
}

.event {
  background-color: white;
  width: calc(43vw);
  margin-bottom: 3vh;
  border-radius: 8px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  padding: 2vw;
  transition: transform 0.3s ease;
}

.event:hover {
  transform: translateY(-5px);
}

/* Form styles */
.event form {
  display: grid;
  gap: 10px;
}

.checkboxes-container {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

.event label {
  display: flex;
  align-items: center;
  color: var(--dark-brown);
  margin-bottom: 5px;
}

.event input[type="text"],
.event input[type="datetime-local"],
.event input[type="tel"],
.event input[type="number"],
.event input[type="email"] {
  width: 90%;
  padding: 1%;
  border: 1px solid var(--medium-green);
  border-radius: 4px;
  font-size: 14px;
}

.event input[type="checkbox"] {
  margin-right: 5px;
  display: inline;
}

.event label[type="checkbox"] {
  margin-right: 15px;
  display: inline;
}

/* Button styles */
.event button {
  background-color: var(--dark-green);
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 4px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  font-size: 16px;
  margin-top: 10px;
}

.event button:hover {
  background-color: var(--medium-green);
}

.event .request-info {
  background-color: var(--light-brown);
}

.event .request-info:hover {
  background-color: var(--dark-brown);
}

/* Create form specific styles */
#create.event {
  width: calc(86vw);
  max-width: 800px;
  margin: 0 auto;
}

#create-form {
  display: grid;
  gap: 10px;
}

#create-form label {
  display: flex;
  flex-direction: column;
}

#create-form input {
  width: 100%;
  padding: 5px;
  border: 1px solid var(--medium-green);
  border-radius: 4px;
  font-size: 14px;
}

.button-container {
  display: flex;
  justify-content: space-between;
  margin-top: 20px;
}

.button-container button {
  flex: 1;
  margin: 0 5px;
}

/* Responsive design */
@media (max-width: 767px) {
  body {
    padding: 10px;
  }

  .event {
    padding: 15px;
    width: calc(100% - 20px);
  }

  .event input[type="text"],
  .event input[type="datetime-local"],
  .event input[type="tel"],
  .event input[type="number"],
  .event input[type="email"] {
    font-size: 16px;
  }

  .event button {
    width: 100%;
    margin-top: 15px;
  }

  #create.event {
    width: calc(100% - 20px);
  }

  .button-container {
    flex-direction: column;
  }

  .button-container button {
    margin: 5px 0;
  }
}
    </style>
</head>
<body>
  <div id="html">
    <h1>Booking and Lead Management</h1>

    <div class="tab">
        <button class="tablinks Bookings" onclick="openTab(event, 'Bookings')" id="defaultOpen">Bookings</button>
        <button class="tablinks Leads" onclick="openTab(event, 'Leads')">Leads</button>
        <button class="tablinks Create" onclick="openTab(event, 'Create')">Create</button>
        <button class="tablinks" id="authTab" onclick="openTab(event, 'Auth')">Authenticate</button>
    </div>
    <div id="Bookings" class="tabcontent">
      <div id="events">
      </div>
  </div>

  <div id="Leads" class="tabcontent">
      <div id="leads">
      </div>
  </div>

  <div id="Create" class="tabcontent">
    <div id="create" class="event">
        <h3>New Event</h3>
        <form id="create-form">
          <textarea id="eventDescription" rows="5" placeholder="Paste event description or conversation here"></textarea>
          <button type="button" id="parseButton">Parse Information</button>
          <br>
            <label>Event Name: <input type="text" name="event_name" value=""></label>
            <label>Customer Name: <input type="text" name="customer_name" value=""></label>
            <label>Summary: <input type="text" name="summary" value=""></label>
            <label>Start Time: <input type="datetime-local" name="start_time" value=""></label>
            <label>End Time: <input type="datetime-local" name="end_time" value=""></label>
            <label>Email Address: <input type="email" name="email_address" value=""></label>
            <label>Phone Number: <input type="tel" name="phone_number" value=""></label>
            <label>Address: <input type="text" name="address" value=""></label>
            <label>Price: <input type="number" name="price" value="" step="0.01"></label>
            <label>Website: <input type="text" name="website" value=""></label>
            <div class="button-container">
                <button type="button" id="clear" class="request-info">Clear Form</button>
                <button type="submit" name="submit-type" value="booking">Submit Booking</button>
                <button type="submit" name="submit-type" value="lead">Submit Lead</button>
            </div>
        </form>
    </div>
</div>
<div id="Auth" class="tabcontent">
  <p id="authStatus">Not authenticated</p>
  <button id="authButton" onclick="initiateAuth()">Authenticate with Google Calendar</button>
</div>
</div>
    <script>

      // Check auth status when the page loads
document.addEventListener('DOMContentLoaded', function() {
    checkAuthStatus();
    const createForm = document.getElementById('create-form');
    const clearButton = document.getElementById('clear');

    if (createForm) {
        createForm.addEventListener('submit', handleFormSubmit);
    }

    if (clearButton) {
        clearButton.addEventListener('click', clearForm);
    }
});
        let isAuthenticated = false;
        let informationrequested=false
        let server="http://localhost:3000"
        let leads = []
        let bookings = []
        document.getElementById('authTab').style.display = isAuthenticated ? 'none' : 'inline';

        function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tabcontent");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tablinks");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    if (evt) {
        evt.currentTarget.className += " active";
    } else {
        document.querySelector(`.tablinks[onclick="openTab(event, '${tabName}')"]`).className += " active";
    }
}

        async function parseEventDescription() {
          if (!isAuthenticated) {
        alert('Please authenticate with Google Calendar first.');
        openTab(null, 'Auth');
        return;
    }
  const textarea = document.getElementById('eventDescription');
  const description = textarea.value.trim();

  if (description === '') {
    alert('Please enter an event description.');
    return;
  }

  try {
    const response = await fetch(server+'/api/parse-event', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ description }),
    });

    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
   
    const parsedData = await response.json();
    console.log(parsedData)
    populateForm(parsedData);
  } catch (error) {
    console.error('Error parsing event description:', error);
    alert('Failed to parse event description. Please try again or fill the form manually.');
  }
}
function populateForm(data) {
  console.log('Received data:', data);

  if (!data) {
    console.error('No data provided to populateForm');
    return;
  }

  const fields = [
    'event_name', 'customer_name', 'summary', 'start_time', 'end_time',
    'email_address', 'phone_number', 'address', 'price', 'website'
  ];

  fields.forEach(field => {
    const input = document.querySelector(`form[id="create-form"] input[name="${field}"]`);
    if (input) {
      console.log(input)
      let value = data[field] || '';
      if (field === 'start_time' || field === 'end_time') {
        value = value ? new Date(value).toISOString().slice(0, 16) : '';
      } else if (field === 'price') {
        value = value ? parseFloat(value).toFixed(2) : '';
      }
      input.value = value;
      console.log(input)

    } else {
      console.warn(`Input with name '${field}' not found`);
    }
  });
}

// Make sure to call this function when the "Parse" button is clicked
document.getElementById('parseButton').addEventListener('click', parseEventDescription);

        // Get the element with id="defaultOpen" and click on it
        document.getElementById("defaultOpen").click();

        function formatDateTimeLocal(dateString) {
  return new Date(dateString).toISOString().slice(0, 16);
}

async function syncCalendar() {
  if (!isAuthenticated) {
        alert('Please authenticate with Google Calendar first.');
        openTab(null, 'Auth');
        return;
    }
  try {
    const response = await fetch(server+'/api/sync-calendar', {
      method: 'POST',
    });
    if (!response.ok) {
      throw new Error('Calendar sync failed');
    }
    console.log('Calendar synced successfully');
  } catch (error) {
    console.error('Error syncing calendar:', error);
  }
}
function handleFormSubmit(e) {
    e.preventDefault();
    if (!isAuthenticated) {
        alert('Please authenticate with Google Calendar first.');
        openTab(null, 'Auth');
        return;
    }
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData.entries());
    console.log(data,"form")

    // Convert date strings to ISO format
    data.start_time = new Date(data.start_time).toISOString();
    data.end_time = new Date(data.end_time).toISOString();

    // Convert price to number
    data.price = parseFloat(data.price) || 0;

    // Determine if it's a booking or lead based on which submit button was clicked
    const isBooking = e.submitter.value === 'booking';

    // Remove submit-type from data before sending to server
    delete data['submit-type'];

    // Create confirmation message
    let confirmMessage = `Are you sure you want to submit this ${isBooking ? 'booking' : 'lead'}?\n\n`;
    confirmMessage += `Event Name: ${data.event_name}\n`;
    confirmMessage += `Customer Name: ${data.customer_name}\n`;
    confirmMessage += `Start Time: ${new Date(data.start_time).toLocaleString()}\n`;
    confirmMessage += `End Time: ${new Date(data.end_time).toLocaleString()}\n`;
    confirmMessage += `Price: $${data.price.toFixed(2)}\n`;

    // Show confirmation dialog
    if (confirm(confirmMessage)) {
        // Send data to server
        fetch(`${server}/api/${isBooking ? 'bookings' : 'leads'}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(result => {
            console.log(`New ${isBooking ? 'booking' : 'lead'} created:`, result);
            
            // Clear the form immediately after successful submission
            clearForm();
            
            // Show a success message
            alert(`New ${isBooking ? 'booking' : 'lead'} created successfully!`);
            
            // Refresh the bookings/leads list
            fetchAllItems();
            
            // Switch to the appropriate tab
            const tabButton = document.querySelector(`.tablinks[onclick="openTab(event, '${isBooking ? 'Bookings' : 'Leads'}')"]`);
            if (tabButton) {
                tabButton.click();
            }
        })
        .catch(error => {
            console.error(`Error creating ${isBooking ? 'booking' : 'lead'}:`, error);
            alert(`Failed to create ${isBooking ? 'booking' : 'lead'}. Please try again.`);
        });
    } else {
        console.log("Submission cancelled by user");
    }
}

function clearForm() {
    document.getElementById('create-form').reset();
}


async function fetchAllItems() {
  if (!isAuthenticated) {
        alert('Please authenticate with Google Calendar first.');
        openTab(null, 'Auth');
        return;
    }
    try {
        const bookingsresponse = await fetch(server+'/api/bookings');
        if (!bookingsresponse.ok) {
            throw new Error('Failed to fetch bookings');
        }
        const leadsresponse = await fetch(server+'/api/leads');
        if (!leadsresponse.ok) {
            throw new Error('Failed to fetch bookings');
        }
          leads = await leadsresponse.json();
          bookings = await bookingsresponse.json();
        console.log(leads,"leads")
        console.log(bookings,"bookings")
        displayItems(bookings);
        displayItems(leads);
    } catch (error) {
        console.error('Error fetching Items:', error);
        document.getElementById('events').innerHTML = '<p>Error loading bookings. Please try again later.</p>';
        document.getElementById('leads').innerHTML = '<p>Error loading leads. Please try again later.</p>';
    }
}


function getConflictingBookingsInfo(ids, type) {
    const idList = ids.split(',');
    let infoList = [];
    
    if (type === 'overlap') {
        infoList = idList.map(id => getBookingInfo(id));
    } else if (type === 'travel') {
        for (let i = 0; i < idList.length; i += 2) {
            infoList.push(getBookingInfo(idList[i], idList[i + 1]));
        }
    }
    
    return infoList.join('<br>');
}

function getBookingInfo(id, travelTime = null) {
  console.log(bookings,"BOOKINGS")
    const booking = bookings.data.find(b => b.id === id);
    if (!booking) {
        return `• Booking ${id}: Info unavailable`;
    }
    
    const bookingName = booking.event_name || booking.customer_name || 'Unnamed booking';
    const bookingTime = new Date(booking.start_time).toLocaleString();
    
    if (travelTime) {
        return `• ${bookingName} (${bookingTime}): ${travelTime} minutes travel time required`;
    } else {
        return `• ${bookingName} (${bookingTime})`;
    }
}


// Fetch all bookings when the program opens
async function displayItems(items, isFullUpdate = true) {
  let eventsContainer;
  let type = items.type;
  if (type == "Bookings") {
    eventsContainer = document.getElementById('events');
  }
  if (type == "Leads") {
    eventsContainer = document.getElementById('leads');
  }
  if (!eventsContainer) {
    console.error("Events container not found!");
    return;
  }
  
  if (isFullUpdate) {
    eventsContainer.innerHTML = '';
  }
  
  const now = new Date();
  items = items.data;
  console.log(items);
  
  for (const item of items) {
    let eventElement = document.getElementById(`event-${item.id}`);
    if (!eventElement) {
      eventElement = document.createElement('div');
      eventElement.id = `event-${item.id}`;
      eventElement.className = 'event';
      eventsContainer.appendChild(eventElement);
    }
    
    const startTime = new Date(item.start_time);
    const endTime = new Date(item.end_time);
    const oneWeekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
    
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    let hasValidEmailAddress = item.email_address && isValidEmail(item.email_address);

    // Pre-compute the conflicting bookings info
    let overlapInfo = '';
    let travelTimeInfo = '';
    if (type === "Leads") {
      if (item.overlapping_booking_ids) {
        overlapInfo = await getConflictingBookingsInfo(item.overlapping_booking_ids, 'overlap');
      }
      if (item.insufficient_travel_time_booking_ids) {
        travelTimeInfo = await getConflictingBookingsInfo(item.insufficient_travel_time_booking_ids, 'travel');
      }
    }

    eventElement.innerHTML = `
    <h3>${item.event_name || item.customer_name || 'Untitled Event'}</h3>
    <form id="form-${item.id}">
        <label>Event Name: <input type="text" name="event_name" value="${item.event_name || ''}"></label>
        <label>Customer Name: <input type="text" name="customer_name" value="${item.customer_name || ''}"></label>
        <label>Summary: <input type="text" name="summary" value="${item.summary || ''}"></label>
        <label>Start Time: <input type="datetime-local" name="start_time" value="${formatDateTimeLocal(item.start_time)}"></label>
        <label>End Time: <input type="datetime-local" name="end_time" value="${formatDateTimeLocal(item.end_time)}"></label>
        <label>Email Address: <input type="email" name="email_address" value="${item.email_address || ''}"></label>
        <label>Phone Number: <input type="tel" name="phone_number" value="${item.phone_number || ''}"></label>
        <label>Address: <input type="text" name="address" value="${item.address || ''}"></label>
        <label>Price: <input type="number" name="price" value="${item.price || 0}" step="0.01"></label>
        ${type == "Bookings" ? `<label>Roving or Show or Both: <input type="text" name="roving_or_show_both" value="${item.roving_or_show_or_both || ''}"></label>` : ''}
        ${type == "Leads" ? `
        <label>Website: <input type="text" name="website" value="${item.website || ''}" step="0.01"></label>
        ` : ''}
        ${type == "Bookings" ? `
        <div class="checkboxes-container">
            <label>Cash: <input type="checkbox" name="seen_me_before" ${item.seen_me_before ? 'checked' : ''}></label>
            <label>Cash: <input type="checkbox" name="cash" ${item.cash ? 'checked' : ''}></label>
            ${endTime < now ? `<label>Customer Happy: <input type="checkbox" name="customer_happy" ${item.customer_happy ? 'checked' : ''}></label>` : ''}
            ${item.sent_invoice ? `<label>Deposit Paid: <input type="checkbox" name="deposit_paid" ${item.deposit_paid ? 'checked' : ''}></label>` : ''}
            <label>Microphone Needed: <input type="checkbox" name="microphone_needed" ${item.microphone_needed ? 'checked' : ''}></label>
            ${endTime < now ? `<label>Full Payment Made: <input type="checkbox" name="full_payment_made" ${item.full_payment_made && item.sent_invoice ? 'checked' : ''}></label>` : ''}
        </div>
        ` : ''}
        ${type === "Leads" ? `
        <div class="conflicts" style="margin-top: 15px; padding: 10px; border: 1px solid #ffcccc; background-color: #fff5f5;">
            ${overlapInfo ? `
            <strong style="color: #cc0000;">Time Overlap Conflicts:</strong><br>
            ${overlapInfo}
            ` : ''}
            ${travelTimeInfo ? `
            <strong style="color: #cc0000;">Insufficient Travel Time:</strong><br>
            ${travelTimeInfo}
            ` : ''}
        </div>
        ` : ''}
        <button type="submit">Update</button>
        ${type == "Leads" ? `<button id="ready-to-book-${item.id}" class="request-info">Ready To Book?</button>` : ''}
        ${item.email_address ? `
            ${hasValidEmailAddress ? `
                ${type == "Bookings" ? `
                    ${endTime < now && !item.review_requested ? `<button id="request-review-${item.id}" class="request-info">Request Review</button>` : ''}
                    ${!item.info_requested ? `<button id="request-info-${item.id}" class="request-info">Request Information</button>` : ''}
                    ${item.price && item.customer_name ?
                        (!item.sent_invoice && !item.cash ? `<button id="send-invoice-${item.id}" class="request-info">Send Invoice</button>` : '')
                    : '<p style="color:red;">Please enter the customer name and booking price before sending invoice.</p>'}
                    ${endTime > now ? `
                        ${startTime < oneWeekFromNow ?
                            (!item.few_days_before ? `
                                <p>This booking is less than a week away, send reminder to customer</p>
                                <button id="send-final-booking-reminder-${item.id}" class="request-info">Send Final Booking Reminder</button>
                            ` : '')
                        : ''}
                    ` : ''}
                ` : ''}
                ${type == "Leads" && !item.sent_follow_up_email ? `
                    <button id="email-follow-up-if-interested-${item.id}" class="request-info">Email follow up if interested</button>
                ` : ''}
            ` : '<p style="color:red;">Email address is not valid format or non-existent</p>'}
        ` : ''}
        <button id="delete-${item.id}" class="request-info">Delete</button>
    </form>
    `

    document.getElementById(`form-${item.id}`).addEventListener('submit', (e) => {
      e.preventDefault();
      if (!isAuthenticated) {
        alert('Please authenticate with Google Calendar first.');
        openTab(null, 'Auth');
        return;
    }
      console.log(item,item.id,type,"id and type")
      const isConfirmed = confirm("Are you sure you want to update this?");
      if (isConfirmed) {
      updateItem(item.id,type);
      }
    });

    document.getElementById(`delete-${item.id}`).addEventListener('click',async (e) => {
      e.preventDefault();
      if (!isAuthenticated) {
        alert('Please authenticate with Google Calendar first.');
        openTab(null, 'Auth');
        return;
    }
      console.log(item,item.id,type,"id and type")      
      const isConfirmed = confirm("Are you sure you want to delete this?");
if (isConfirmed) {
    document.getElementById(`event-${item.id}`).remove();
      await fetch(server + '/delete', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                bookingid: item.id,
                type:type
              }),
            });  
          }
        });

// Lead conversion event listener
if (type == "Leads") {
  document.getElementById(`ready-to-book-${item.id}`).addEventListener('click', async (e) => {
    e.preventDefault();
    if (!isAuthenticated) {
        alert('Please authenticate with Google Calendar first.');
        openTab(null, 'Auth');
        return;
    }
    console.log(item, item.id, type, "id and type");
    
    const isConfirmed = confirm("Are you sure you want to convert this to a booking?");
    
    if (isConfirmed) {
      try {
        console.log("converting lead to booking");

const response = await fetch(server + '/api/bookings', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify(item),
});

if (!response.ok) {
  throw new Error('Failed to convert lead to booking');
}

const result = await response.json();
console.log('Converting lead to booking, created google event', result);

        const responsetwo = await fetch(server + '/remove-lead', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            leadId: item.id
          }),
        });

        if (!responsetwo.ok) {
          throw new Error('Failed to convert lead to booking');
        }

        const resulttwo = await responsetwo.json();
       console.log(resulttwo)
        // Remove the lead from the DOM
        document.getElementById(`event-${item.id}`).remove();

        // Refresh the bookings list
        await fetchAllItems();

        // Optionally, you might want to scroll to the new booking or highlight it
        // This depends on how your displayBookings function works
        const newBookingElement = document.getElementById(`event-${result.newBookingId}`);
        if (newBookingElement) {
          newBookingElement.scrollIntoView({ behavior: 'smooth' });
          newBookingElement.classList.add('highlight');
          setTimeout(() => newBookingElement.classList.remove('highlight'), 3000);
        }

      } catch (error) {
        console.error('Error converting lead to booking:', error);
        alert('An error occurred while converting the lead to a booking. Please try again.');
      }
    } else {
      console.log('Conversion cancelled by user');
    }
  });
}
        
    if(hasValidEmailAddress){
      const requestInfoButton = document.getElementById(`request-info-${item.id}`);
      if (requestInfoButton) {
        requestInfoButton.addEventListener('click', async (e) => {
          e.preventDefault();
          if (!isAuthenticated) {
        alert('Please authenticate with Google Calendar first.');
        openTab(null, 'Auth');
        return;
    }
          const emailContent = generateInfoRequestEmail(item);
          console.log(emailContent, "emailContent");
          try {
            if(emailContent){
              await fetch(server + '/send-email', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  to: item.email_address,
                  subject: `Information Request for Your Event on ${new Date(item.start_time).toLocaleDateString()}`,
                  text: emailContent,
                }),
              });
            }
            item.info_requested = true;
            await updateBookingInDatabase(item);
            requestInfoButton.remove();
          } catch (error) {
            console.error('Error sending information request:', error);
          }
        });
      }

      const requestReviewButton = document.getElementById(`request-review-${item.id}`);
      if (requestReviewButton) {
        requestReviewButton.addEventListener('click', async (e) => {  
          e.preventDefault();
          if (!isAuthenticated) {
        alert('Please authenticate with Google Calendar first.');
        openTab(null, 'Auth');
        return;
    }
          try {
            await fetch(server + '/send-email', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                to: item.email_address,
                subject: `Review Request`,
                booking: generateReviewRequestEmail(item),
              }),
            });
            item.review_requested = true;
            await updateBookingInDatabase(item);
            requestReviewButton.remove();
          } catch (error) {
            console.error('Error sending invoice:', error);
          }
        });  
      }

      const sendInvoiceButton = document.getElementById(`send-invoice-${item.id}`);
      if (sendInvoiceButton) {
        sendInvoiceButton.addEventListener('click', async (e) => {  
          e.preventDefault();
          if (!isAuthenticated) {
        alert('Please authenticate with Google Calendar first.');
        openTab(null, 'Auth');
        return;
    }
          try {
            await fetch(server + '/send-invoice-request', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                to: item.email_address,
                subject: `Invoice for the Magic Show at your Event on ${new Date(item.start_time).toLocaleDateString()}`,
                text: item,
              }),
            });
            item.sent_invoice = true;
            await updateBookingInDatabase(item);
            sendInvoiceButton.remove();
          } catch (error) {
            console.error('Error sending invoice:', error);
          }
        });  
      }

      const sendFinalReminderButton = document.getElementById(`send-final-booking-reminder-${item.id}`);
      if (sendFinalReminderButton) {
        sendFinalReminderButton.addEventListener('click', async (e) => {  
          e.preventDefault();
          if (!isAuthenticated) {
        alert('Please authenticate with Google Calendar first.');
        openTab(null, 'Auth');
        return;
    }
          try {
            await fetch(server + '/send-email', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                to: booking.email_address,
                subject: `Reminder: Your Upcoming Magic Show on ${new Date(item.start_time).toLocaleDateString()}`,
                text: generateFinalReminderEmail(item),
              }),
            });
            item.few_days_before = true;
            await updateBookingInDatabase(item);
            sendFinalReminderButton.remove();
            sendFinalReminderButton.previousElementSibling.remove(); // Remove the paragraph above the button
          } catch (error) {
            console.error('Error sending final booking reminder:', error);
          }
        });
      }

     if(type=="Leads"){
      const followUpIfInterestedButton = document.getElementById(`email-follow-up-if-interested-${item.id}`);
      if (followUpIfInterestedButton) {
        followUpIfInterestedButton.addEventListener('click', async (e) => {  
          e.preventDefault();
          if (!isAuthenticated) {
        alert('Please authenticate with Google Calendar first.');
        openTab(null, 'Auth');
        return;
    }
          try {
            await fetch(server + '/send-email', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                to: booking.email_address,
                subject: `Potential Magic Show Booking`,
                text: generateFollowUpIfInterestedEmail(item),
              }),
            });
            item.sent_follow_up_email = true;
            await updateBookingInDatabase(item);
            followUpIfInterestedButton.remove();
            // followUpIfInterestedButton.previousElementSibling.remove(); // Remove the paragraph above the button
          } catch (error) {
            console.error('Error sending follow up if interested email:', error);
          }
        });
      }
     }

    }
  }

  if (isFullUpdate) {
    Array.from(eventsContainer.children).forEach(child => {
      const id = child.id.replace('event-', '');
      if (!items.some(booking => booking.id === id)) {
        eventsContainer.removeChild(child);
      }
    });
  }
}

async function updateBookingInDatabase(booking) {
  try {
    const response = await fetch(server+'/api/bookings/update', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(booking),
    });
    if (!response.ok) {
      throw new Error('Failed to update booking');
    }
  } catch (error) {
    console.error('Error updating booking:', error);
  }
}

function generateFollowUpIfInterestedEmail(booking) {
  let message= `Dear ${booking.customer_name},

Are you still interested in booking a magic show on ${new Date(booking.start_time).toLocaleDateString()} at ${booking.address}?

Best regards,

Julian Bull`;
navigator.clipboard.writeText(message).then(() => {
      console.log('Text copied to clipboard');
    }).catch(err => {
      console.error('Failed to copy text: ', err);
    });
    return message
}

function generateFinalReminderEmail(booking) {
  let message=`Dear ${booking.customer_name},

This is a friendly reminder about your upcoming magic show event on ${new Date(booking.start_time).toLocaleDateString()} at ${booking.address}.

If you have any last-minute questions or concerns, please don't hesitate to reach out.

Looking forward to a magical event!

Best regards,

Julian Bull`;
navigator.clipboard.writeText(message).then(() => {
      console.log('Text copied to clipboard');
    }).catch(err => {
      console.error('Failed to copy text: ', err);
    });
    return message}

function generateReviewRequestEmail(booking) {
  let num=Math.floor(Math.random()*5)+1
    let prompt
    if (num==1){
        prompt = `Would you mind leaving a review of my work here please? https://www.facebook.com/ItsCrowdPleaser/reviews 
    Crowdplease is like a booking agent, I get jobs through them. They've been very good to me, so I try to make them look good.`
    }
    if (num==2){
        prompt = `Would you mind leaving a review of my work here please? https://www.facebook.com/Julianbullmagic`
    }
    if (num==3){
        prompt = `Would you mind leaving a review of my work on Oneflare's Google profile? You can find it by Google Searching for 
        "Oneflare". Oneflare is like a booking agent, I get jobs through them. They've been very good to me, so I try to make them look good.`
    }
    if (num==4){
        prompt = `Would you mind leaving a review of my work on Crowdpleaser's Google profile? You can find it by Google Searching for 
        "Crowdpleaser". Crowdpleaser is like a booking agent, I get jobs through them. They've been very good to me, so I try to make them look good.`
    }
    if (num==5){
        prompt = `Would you mind leaving a review of my work on my Google profile? You can find it by Google Searching for 
        "Julian bull magic".`
    }
    console.log(prompt,num)

  let message=`Dear ${booking.customer_name},

${prompt}

Best regards,

Julian Bull`;

navigator.clipboard.writeText(message).then(() => {
      console.log('Text copied to clipboard');
    }).catch(err => {
      console.error('Failed to copy text: ', err);
    });
    return message
}

function generateInfoRequestEmail(booking) {
  let message = `Hi ${booking.customer_name || 'there'},\n\n`;
  message += "I need some additional information for your upcoming event. Could you please provide the following details:\n\n";
 let sendMessage=false
  const questions = {
    phone_number: "What is your contact phone number?",
    address: "What is the address of the event?",
    cash: "Will you be paying in cash? Any method is fine with me except credit or debit card.",
    microphone_needed: "Will you need a microphone for this event?",
  };

  for (const [key, question] of Object.entries(questions)) {
    if (booking[key] === null) {
      console.log(key)
      sendMessage=true
      message += `${question}\n`;
    }
  }
  message += `\nAlso, I need to double check the exact time and address of the booking are correct. Have you taken into account that guests may take some time to fully arrive? I suppose you did already I just need to double check, can never be too careful with these things.`;


  message += "\nThank you for your help. We look forward to making your event a success!";
console.log(message)
  if(sendMessage){
    navigator.clipboard.writeText(message).then(() => {
      console.log('Text copied to clipboard');
    }).catch(err => {
      console.error('Failed to copy text: ', err);
    });
    return message  }
  if(!sendMessage){
    return null
  }
}

function updateItem(id,type) {
  if (!isAuthenticated) {
        alert('Please authenticate with Google Calendar first.');
        openTab(null, 'Auth');
        return;
    }
  const form = document.getElementById(`form-${id}`);
  console.log(form);
  const updatedItem = {
    id: id,
    start_time: new Date(form.start_time.value).toISOString(),
    end_time: new Date(form.end_time.value).toISOString(),
    address: form.address.value || null,
    phone_number: form.phone_number.value || null,
    email_address: form.email_address.value || null,
    customer_name: form.customer_name.value || null,
    event_name: form.event_name.value || null,
  };

  if(type=="Bookings"){
    updatedItem.price=0
    updatedItem.seen_me_before= null
    updatedItem.cash= null
    updatedItem.customer_happy= null
    updatedItem.deposit_paid= null
    updatedItem.few_days_before= null
    updatedItem.microphone_needed= null
    updatedItem.review_requested= null
    updatedItem.full_payment_made= null
    updatedItem.sent_invoice= null
  }
  if(type=="Leads"){
    updatedItem.website= null
    updatedItem.sent_follow_up_email= null
  }
  if (form.seen_me_before) updatedItem.seen_me_before = form.seen_me_before;
  if (form.roving_or_show_or_both) updatedItem.roving_or_show_or_both = form.roving_or_show_or_both.value;
  if (form.website) updatedItem.website = form.website.value;
  if (form.price) updatedItem.price = parseFloat(form.price.value) || 0;
  if (form.cash) updatedItem.cash = form.cash.checked;
  if (form.customer_happy) updatedItem.customer_happy = form.customer_happy.checked;
  if (form.deposit_paid) updatedItem.deposit_paid = form.deposit_paid.checked;
  if (form.few_days_before) updatedItem.few_days_before = form.few_days_before.checked;
  if (form.microphone_needed) updatedItem.microphone_needed = form.microphone_needed.checked;
  if (form.review_requested) updatedItem.review_requested = form.review_requested.checked;
  if (form.full_payment_made) updatedItem.full_payment_made = form.full_payment_made.checked;
  if (form.sent_invoice) updatedItem.sent_invoice = form.sent_invoice.checked;

 console.log(type,"type")

  // Send update to server using fetch
  fetch(`http://localhost:3000/api/${type.toLowerCase()}/update`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(updatedItem),
  })
  .then(response => response.json())
  .then(data => {
    console.log('Update successful:', data);
    // Optionally update the display here if needed
    displayItems([data.data], false);
  })
  .catch(error => {
    console.error('Error updating item:', error);
    // Handle error (e.g., show an error message to the user)
  });
}

function initiateAuth() {
    const authWindow = window.open(`${server}/auth`, 'Auth', 'width=500,height=600');
    
    window.addEventListener('message', function(event) {
        if (event.data === 'auth-success') {
            checkAuthStatus();
            authWindow.close();
        } else if (event.data === 'auth-error') {
            alert('Authentication failed. Please try again.');
            authWindow.close();
        }
    }, false);
}

function checkAuthStatus() {
    fetch(`${server}/auth-status`)
        .then(response => response.json())
        .then(data => {
            isAuthenticated = data.isAuthenticated;
            updateAuthUI();
            if (!isAuthenticated) {
                openTab(null, 'Auth');
            } else {
                syncCalendar();
                fetchAllItems();
            }
        })
        .catch(error => console.error('Error checking auth status:', error));
}
function updateAuthUI() {
    const authStatus = document.getElementById('authStatus');
    const authButton = document.getElementById('authButton');
    const tablinks = document.getElementsByClassName("tablinks");
    
    if (isAuthenticated) {
        authStatus.textContent = 'Authenticated';
        authStatus.style.color = 'green';
        authButton.textContent = 'Re-authenticate';
        // Show other tabs
        for (let i = 0; i < tablinks.length; i++) {
            if (tablinks[i].textContent !== 'Authenticate') {
                tablinks[i].style.display = '';
            }
        }
        openTab(null, 'Bookings');
    } else {
        authStatus.textContent = 'Not authenticated';
        authStatus.style.color = 'red';
        authButton.textContent = 'Authenticate with Google Calendar';
        // Hide other tabs
        for (let i = 0; i < tablinks.length; i++) {
            if (tablinks[i].textContent !== 'Authenticate') {
                tablinks[i].style.display = 'none';
            }
        }
    }
}
</script>
</body>
</html>